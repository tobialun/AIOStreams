name: Redeploy Koyeb via API

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  redeploy:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Koyeb redeploy
        run: |
          echo "üöÄ Triggering Koyeb redeploy..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.KOYEB_TOKEN }}" \
            https://app.koyeb.com/v1/apps/aiostreams/services/41139c72-62d8-4f3c-930c-0924dd99903b/redeploy)

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "üì° Response status: $STATUS"
          echo "üìù Response body:"
          echo "$BODY"

          if [ "$STATUS" -ne 204 ]; then
            echo "‚ùå Koyeb redeploy failed."
            exit 1
          else
            echo "‚úÖ Koyeb redeploy succeeded."
          fi
